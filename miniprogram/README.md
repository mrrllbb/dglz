# 大怪路子 - 微信小程序版本

## 项目概述

本项目是"大怪路子"纸牌游戏的微信小程序版本，通过WebSocket与服务器实时通信，支持多人在线游戏。

## 项目结构

```
miniprogram/
├── pages/                          # 页面文件夹
│   ├── index/                      # 首页（加入游戏界面）
│   │   ├── index.wxml              # 页面结构
│   │   ├── index.js                # 页面逻辑
│   │   └── index.wxss              # 页面样式
│   ├── lobby/                      # 大厅页面（等待游戏开始）
│   │   ├── lobby.wxml
│   │   ├── lobby.js
│   │   └── lobby.wxss
│   ├── game/                       # 游戏主页面
│   │   ├── game.wxml
│   │   ├── game.js
│   │   └── game.wxss
│   └── gameOver/                   # 游戏结束页面
│       ├── gameOver.wxml
│       ├── gameOver.js
│       └── gameOver.wxss
├── components/                     # 自定义组件
│   └── card/                       # 卡牌组件（可选）
├── utils/                          # 工具函数
│   └── cardUtils.js                # 卡牌相关工具函数
├── assets/                         # 资源文件夹
├── app.js                          # 小程序主文件
├── app.json                        # 小程序配置
├── app.wxss                        # 全局样式
├── sitemap.json                    # 小程序站点地图
├── BACKEND_ADAPTATION.md           # 后端适配指南
└── README.md                       # 项目说明（本文件）
```

## 页面说明

### 1. 首页 (pages/index)
- **功能**: 用户可选择作为玩家或旁观者加入游戏
- **操作**: 输入用户名，点击加入按钮
- **流程**: 首页 → 大厅

### 2. 大厅页面 (pages/lobby)
- **功能**: 显示当前玩家列表，等待游戏开始
- **信息**: 显示玩家数、旁观者数
- **操作**: 只有第一个玩家可以开始游戏（需要偶数个玩家）
- **流程**: 大厅 → 游戏

### 3. 游戏主页面 (pages/game)
- **功能**: 游戏的核心界面
- **区域**:
  - 游戏头部: 显示当前轮到的玩家
  - 玩家信息区: 显示其他玩家的手牌数
  - 游戏中心: 显示最后一手牌
  - 我的手牌: 可点击选择要出的牌
  - 操作按钮: 出牌、Pass、清空
- **交互**: 点击卡牌选择/取消选择，点击出牌发送

### 4. 游戏结束页面 (pages/gameOver)
- **功能**: 显示游戏结果
- **信息**: 获胜队伍、最终排名
- **操作**: 可选择再来一局或返回大厅

## 核心功能

### 通信机制
- **连接**: WebSocket连接到服务器
- **消息格式**: 所有消息都是JSON格式
- **自动重连**: 连接断开时自动重连

### 游戏流程
1. 用户在首页选择加入方式（玩家/旁观者）
2. 进入大厅，等待足够的玩家加入
3. 游戏开始后，进入游戏主页面
4. 根据游戏规则轮流出牌
5. 一方队伍全部出完牌即为获胜
6. 进入结束页面，可选择继续或退出

### 卡牌系统
- 支持标准扑克牌（3-A, 2, 黑红王）
- 卡牌按价值排序（3最小，2和王最大）
- 支持各种出牌组合（单牌、对牌、三张、顺子等）

## 快速开始

### 前置要求
1. 微信开发者工具
2. 微信小程序AppID
3. 运行的服务器（支持WebSocket）

### 安装步骤

1. **克隆项目**
   ```bash
   git clone https://github.com/xxtrainsxx/dglz.git
   cd dglz
   ```

2. **打开微信开发者工具**
   - 新建 → 导入
   - 选择 `miniprogram` 文件夹
   - 输入AppID

3. **配置服务器地址**
   编辑 `miniprogram/app.js`：
   ```javascript
   globalData: {
     serverUrl: 'ws://YOUR_SERVER_URL:8000'
   }
   ```

4. **启动后端服务**
   ```bash
   npm install
   node server/app.js
   # 或使用小程序适配版本
   node server/app-miniprogram.js
   ```

5. **在开发者工具中编译运行**

## 后端适配

详见 `BACKEND_ADAPTATION.md`

现有的Node.js服务器需要进行以下改动：
- 添加WebSocket支持
- 修改消息格式为JSON
- 实现用户认证（基于uid）
- 添加心跳机制
- 支持生产环境的WSS连接

## 开发指南

### 添加新页面
1. 在 `pages/` 目录创建新文件夹
2. 创建 `.wxml`, `.js`, `.wxss` 三个文件
3. 在 `app.json` 的 `pages` 数组中添加路径
4. 在 `index.wxml` 中添加导航链接

### 修改样式
- 全局样式: `app.wxss`
- 页面样式: 各页面的 `.wxss` 文件
- 使用 `rpx` 单位（响应式像素单位）

### 添加工具函数
在 `utils/` 文件夹中创建新的JS文件，示例见 `cardUtils.js`

### 调试
- 使用微信开发者工具的控制台
- 使用 `console.log()` 记录调试信息
- 使用 `wx.showToast()` 显示用户提示

## 小程序发布

### 预发布检查清单
- [ ] 服务器地址已配置为正式域名（HTTPS/WSS）
- [ ] 测试了各种网络条件下的连接稳定性
- [ ] 实现了完整的错误处理和重连机制
- [ ] 隐私政策已准备并在首页显示
- [ ] 已获得必要的用户权限声明

### 提交审核
1. 在微信小程序管理后台上传代码
2. 填写版本信息和更新说明
3. 提交审核
4. 等待微信审核通过

## API 文档

### WebSocket 消息类型

#### 客户端发送
- `check`: 检查出牌合法性
- `play`: 执行出牌
- `send card`: 发送贡献卡牌
- `get update`: 获取游戏更新
- `message`: 发送游戏消息

#### 服务器响应
- `update`: 游戏状态更新
- `check ok`: 出牌合法
- `check error`: 出牌不合法
- `game started`: 游戏开始
- `game over`: 游戏结束
- `error`: 错误信息
- `new player`: 新玩家加入
- `player left`: 玩家离开

## 常见问题

### Q: WebSocket连接失败
A: 检查服务器地址配置，确保WSS/WS协议正确，防火墙允许连接

### Q: 收不到服务器消息
A: 检查消息格式是否为JSON，检查uid是否正确

### Q: 游戏进行中掉线了怎么办
A: 小程序会自动重新连接，游戏状态由服务器维护

### Q: 如何测试本地开发
A: 使用 `ws://localhost:8000`，但微信小程序限制本地IP，建议使用内网IP或配置代理

## 许可证
ISC

## 作者
该项目基于原有的Web版本改写

## 更新日志

### v1.0.0 (2024)
- ✅ 完成基础页面框架
- ✅ 实现WebSocket通信
- ✅ 实现游戏基本流程
- ✅ 卡牌显示和交互

## 贡献
欢迎提交Issue和Pull Request！
